---
title: "Bayesian Coursework"
output: pdf_document
date: "2024-04-08"
editor_options: 
  chunk_output_type: inline
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(dplyr)
library(rjags)
library(bayesplot)
library(posterior)
```

```{r load_df}
# Load dataset.
sgaj <- read.csv("sgaj.csv")
head(sgaj, 7)
```

# Part 1

```{r}
summary(sgaj$age)

# Create age groups
sgaj_with_age_groups <- sgaj %>%
  mutate(age_group = case_when(
    age >= 18 & age <= 30 ~ "18-30",
    age >= 31 & age <= 50 ~ "31-50",
    age >= 51 & age <= 70 ~ "51-70",
    age > 70 ~ "71+"
  ))
```

After reviewing the age distribution in the dataset, I decided to categorise the age variable into four groups: 18-30 (young adults), 31-50 (middle-aged adults), 51-70 (older adults), and 71+ (seniors). This is done solely for visualisation purposes (not used in the model) as it allows for the ordering (and separation in facets) of patients based on their age, making the exploration of how age and gender affect SGAJ easier to interpret.

```{r}
ggplot(sgaj_with_age_groups, aes(x = as.factor(time), y = measured, group = patient, color = as.factor(female))) + 
  geom_point(size = 3) +
  geom_line(linewidth = 1.3) + 
  facet_wrap(~age_group, ncol = 4) +
  theme_classic() +
  theme(
    axis.text.x = element_text(size = 10),  # Bigger x-axis text
    axis.text.y = element_text(size = 10),  # Bigger y-axis text
    axis.ticks = element_line(size = 1)     # Thicker axis ticks
  ) +
  labs(
    title = "Trajectory of SGAJ levels by Patient - Faceted by Age Group",
    x = "Time After SEYAB Administration (hours)",
    y = expression(Measured~SGAJ~(mu*mol/L)),
    color = "Sex"
  ) +
  scale_color_manual(
    values = c("blue", "pink"), 
    labels = c("Male", "Female")  # Set labels for Male and Female
  )
```

The plot shows the trajectory of SGAJ level (across the timepoints) for each patient, facetted by the different age groups (to aid visualisation). The following insights can be drawn from the plot:

- There appears to be a positive association between age and SGAJ levels, suggesting that older patients tend to have higher biomarker concentrations.

- In younger age groups, female patients display higher SGAJ levels than male patients (in most time points). In contrast, in the senior age group (71+ years), this pattern is reversed, with male patients presenting higher SGAJ levels.

- Each patient has a different starting level of SGAJ (time=0) which suggests the need for a random intercept. Furthermore, the rate at which SGAJ levels change over time is not constant across patients; In general, older patients have a faster rate SGAJ growth than younger patients but there is still a lot of variability between patients, suggesting the need for a random slope on time.

- Given the limited samples (12 patients), not strong conclusions can be drawn. Furthermore, I acknowledge that unmeasured factors (such as medication, lifestyle) might influence SGAJ levels and could confound the observed associations with age and sex.

# Part 2

## 2.1 Assumptions
- The SGAJ level for patient `i` at time `t` follows a Normal distribution.
- *Linearity:* The model is linear. The relationship between the dependent variable (SGAJ) and each of the covariates is assumed to be linear.
- *Additive:* Simplifying assumption that there is no interaction between the covariates (model is additive). 
- *Exchangeability:* Before considering the data, we treat all patients as essentially the same.  The prior distributions for the group-specific parameters \( \alpha_i\) and \(\gamma_i\) reflect this assumption. After seeing the data, the model allows these parameters to differ, but the starting point is a belief in their similarity.

## 2.2 Model formulation
The SGAJ level for each patient \(i\) at time \(t\) is modeled as following a normal distribution with mean \(\mu_{it}\), the expected measurement at reference values, and a fixed standard deviation of 75, as per the brief's suggestion.
$$
y_{it} \sim \mathcal{N}(\mu_{it}, 75^2)
$$
$$
\mu_{it} = \alpha_i + \beta_{\text{age}}\left(\text{age}_i - 50 \right)/10 + \beta_{\text{female}}(1- \text{female}_i) + \gamma_{i}\left(\text{time}_t - 12 \right)/6
$$

### 2.2.1 Priors on alpha
The variability between patients $i$ is represented by a random effect $\alpha_i$ (patient-specific random intercept), which is assumed to be drawn from a Normal distribution with mean $\mu_a$ and variance $\sigma_a^2$.
$$
\alpha_{i} \sim \mathcal{N}(\mu_{a}, \sigma_a^2)
$$
$$
\mu_a \sim \mathcal{N}(225, 20.41^2)
$$
$$
\sigma_a \sim \text{Uniform}(80, 100)
$$
- I am assuming that the random intercept $a_i$ representing the deviation in baseline SGAJ level for each patient from the population average under reference conditions (age=50, female=1, time=12 hours), follows a Normal distribution. 

- $\mu_a$ represents the average value (intercept) across the population for the reference group when other predictors (e.g., age, female, time) are held at their reference levels. Being influenced by the information from the previous study, I am assuming that $\mu_a$ has an average value of 225. The standard deviation of $\mu_a$ is calculated as (265-185)/(1.96*2)=20.41, with a 95% upper and lower credible limit of 265 and 185 respectively.

- For the random effects standard deviation $\sigma_a$, I am setting it as a uniform distribution between 80 and 100 to account for some uncertainty around the value 90 suggested from the previous study.

### 2.2.2 Priors on beta_age and beta_female
The terms involving $\beta_{age}$, and $\beta_{female}$ correspond to the fixed effects of age (centered around the age of 50 and scaled such that a unit increase is in 10 years), and female (has the value 1 if female and zero otherwise), respectively. 
$$
\beta_{\text{age}} \sim \mathcal{N}(0, 10^2)
$$
$$
\beta_{\text{female}} \sim \mathcal{N}(0.1, 10^2)
$$
- As stated in the brief, the effect of $\beta_{age}$ and $\beta_{female}$ is not well understood, therefore I am assuming vague priors and relying on data to inform these relationships. For the prior of $\beta_{female}$, I am subtly incorporating the expectation that males may have slightly higher SGAJ levels than females (as explained by the principal investigator).

### 2.2.3 Priors on gamma
\(\gamma_{i}\) is modelled as a random effect and represents the patient-specific rate of change of SGAJ levels - capturing individual variability in response to the drug over time. The term \(\gamma_{i}(time_t - 12)/6\) normalizes this rate of change to a 6-hour period; without this random slope, we would observe only different initial SGAJ levels but uniform rates of change across individuals. I am assuming that \(\gamma_{i}\) follows a normal distribution with mean \(\mu_{\gamma}\) and variance \(\sigma_{\gamma}^2\).

$$
\gamma_{i} \sim \mathcal{N}(\mu_{\gamma}, \sigma_{\gamma}^2)
$$
$$
\mu_{\gamma} \sim \mathcal{N}(0, 10^2)
$$
$$
\sigma_{\gamma} \sim \text{Uniform}(0, 100)
$$

- For $mu_{gamma}$ and $sigma_{gamma}$ I chose vague priors due to the lack of specific prior information, ensuring that the inferences are driven predominantly by the observed data rather than by subjective assumptions. I chose wide uniform and large variance normal distributions for these priors to offer the flexibility needed for the model to adapt and learn from the data.

## 2.3 RJAGS

```{r}
# Initialisation of data
data <- list(n_patients = length(unique(sgaj$patient)), 
             patient = sgaj$patient,
             age = sgaj$age,
             time = sgaj$time,
             female = sgaj$female,
             n = nrow(sgaj),
             y = sgaj$measured
)
```

Constructing a hierarchical linear regression model based on the assumptions and model formulation described above. Checking convergence of the model from two different chains - starting from slightly different initial values.
```{r}
# Model definition
model <- "model{
  # Linear regression model
  for (i in 1:n) {
    mu[i] <- alpha[patient[i]] + beta_age*(age[i] - 50)/10 + beta_female*(1-female[i]) + gamma[patient[i]]*(time[i] - 12)/6 
    y[i] ~ dnorm(mu[i], prec_psi)
    yrep[i] ~ dnorm(mu[i], prec_psi) # posterior-predictive distribution
  }
  
  # Random effects
  for (p in 1:n_patients) {
    alpha[p] ~ dnorm(mu_alpha, prec_alpha)
    gamma[p] ~ dnorm(mu_gamma, prec_gamma)
    rate_of_change[p] <- gamma[p] * 4 
  }
  
  # Priors for fixed effects
  beta_age ~ dnorm(0, 1/(10^2))
  beta_female ~ dnorm(0.1, 1/(10^2))

  # Prior for the population average of the random intercepts
  mu_alpha ~ dnorm(225, 1/(20.41^2))

  # Prior for the standard deviation of the random intercepts
  sd_alpha ~  dunif(80,100)
  prec_alpha <- 1/(sd_alpha^2)
  
  # Prior for the population average of the random slope
  mu_gamma ~ dnorm(0, 1/(10^2))
  
  # Prior for the standard deviation of the random slope
  sd_gamma ~ dunif(0, 100)
  prec_gamma <- 1/(sd_gamma^2)

  prec_psi <- 1/(75^2)
}"


# Two different initial values - to check that the model is converging to the same conclusion
initial_values <- list(list(alpha=rep(200, data$n_patients), sd_alpha=80, mu_gamma=0, sd_gamma=20, beta_age=0, beta_female=0, .RNG.name = c("base::Mersenne-Twister"), .RNG.seed = 20), list(alpha=rep(100, data$n_patients), sd_alpha=95, mu_gamma=1, sd_gamma=50, beta_age=1, beta_female=1, .RNG.name = c("base::Mersenne-Twister"), .RNG.seed = 42))

# Model setup
jags_model <- jags.model(textConnection(model), 
                         data = data, 
                         inits = initial_values, 
                         n.chains = 2)

# Burn-in
update(jags_model, 1000)

pars <- c("alpha", "mu_alpha", "sd_alpha", "beta_age", "beta_female", "gamma", "mu_gamma", "sd_gamma", "rate_of_change", "yrep")

# Sampling
set.seed(2292) 
samples <- coda.samples(jags_model, 
                        variable.names = pars,
                        n.iter = 200000,
                        thin=10)


# Get draws
sgaj_draws <- as_draws(samples)
```

## 2.4 Summarising posterior distributions of key quantities of interest
```{r}
# Function that returns posterior summary for only specified parameters. 
# The summmary includes the 2.5%, 50%, 97.5% quantiles, convergence measures (rhat, ESS), and monte carlo standard error 
get_posterior_summary <- function(draws, pars) {
  subsetted_draws <- subset_draws(draws, variable = pars)
  summary_subsetted_draws <- summary(subsetted_draws, ~quantile(.x, probs = c(0.025, 0.5, 0.975)), default_convergence_measures(), c("mcse_mean", "mcse_median"))
  
  return(summary_subsetted_draws)
}
```

### 2.4.1 Random intercept
```{r}
mcmc_trace(samples, pars=c(paste0("alpha[",1:12,"]")))
print(get_posterior_summary(sgaj_draws, c(paste0("alpha[",1:12,"]"))))
```
**Convergence:** The traceplots suggest a well-mixed distribution ("fat hairy caterpillar" appearance), indicating stable estimates with random dispersion around the mean. The overlap of both chains and an $\hat{R}$ value of 1.00 (3 s.f.) for all parameters show no signs of convergence issues. This implies that within-chain and between-chain variances are comparable. The ESS values range from approximately 36,000 to 40,000 for both bulk and tail. High ESS values suggest that the sample provides a reliable approximation of the posterior distribution, reducing the error in our estimates and increasing the confidence in statistical inferences. The monte carlo standard error (MCSE) values for the mean range from 0.16 to 0.21 and for the median from 0.18 to 0.26. These values indicate the variability of the estimate if the entire Monte Carlo simulation were repeated under the same conditions. Given the magnitude of the estimated parameters, the observed MCSE values are low, which substantiates the precision and reliability of our estimates.

**Interpretation:** The median values (50% quantile), representing the central tendency of the random intercept estimates, demonstrate considerable variation across patients. Notably, patient 6 exhibits both the lowest median at 234 and the narrowest 2.5% to 97.5% quantile interval, ranging from 169 to 298. Conversely, patient 3 shows the highest median at 510, accompanied by the broadest interval from 433 to 591. 

### 2.4.2 Fixed effects

```{r}
mcmc_trace(samples, pars=c("beta_age", "beta_female"))
print(get_posterior_summary(sgaj_draws, c("beta_age", "beta_female")))
```
**Convergence:** The traceplots show stable mean with random dispersion around the mean and both chains overlap. The $\hat{R}$ statistic is estimated to be 1.00, giving no suggestion of any lack of convergence. The mean MCSE values for both are smaller than 0.05. 

**Interpretation:** 
- The median value of the \(\beta_{age}\) coefficient at 19.3 indicates that SGAJ levels typically rise by about 19.3 (3.99-34.3) units for each decade past 50 years, and decrease by the same amount per decade before 50 (all other values held constant at their reference levels). This further confirms that age has a positive effect on SGAJ levels.
- The \(\beta_{female}\) coefficient's median at 6.14 suggests males have SGAJ levels that are typically 6.14 units higher than females (all other things constant), but with a broad 95% credible interval from -13.0 to 25.3, there is considerable uncertainty around this effect. 

### 2.4.3 Random slope
```{r}
mcmc_trace(samples, pars=c(paste0("gamma[",1:12,"]")))
print(get_posterior_summary(sgaj_draws, c(paste0("gamma[",1:12,"]"))))
```
*Convergence:* The traceplots show stable mean with random dispersion around the mean and both chains overlap. The $\hat{R}$ statistic is estimated to be 1.00 across all the gammas (no suggestion of any lack of convergence). The mean MCSE values are between 0.08 and 0.18. 

*Interpretation:* The summary statistics for the patient-specific rate of change of SGAJ levels (gamma[1]-gamma[12]) across 12 patients reveal considerable diversity in response dynamics, both in magnitude and direction. Median estimates range from a decrease of -8.40 in patient 8 every 6 hours to a substantial increase of 43.5 in patient 3, illustrating the complex and individualized nature of biological responses to treatment.

### 2.4.4 Hyper-parameters 

```{r}
# Check convergence for random intercept (alpha).
mcmc_trace(samples, pars=c("mu_alpha", "sd_alpha", "mu_gamma", "sd_gamma"))
# TODO: about sd: the margenalised prior is equal to the margenalised posterior. The data doesn't further constraint of the uncertainty of alpha.

get_posterior_summary(sgaj_draws, c("mu_alpha", "sd_alpha", "mu_gamma", "sd_gamma"))
```

*Convergence:* The traceplots show stable mean with random dispersion around the mean and both chains overlap. All hyper-parameters indicate convergence with $\hat{R}$ values at 1.00. The MCSE is under 0.1 for all the hyper-parameters.

*Interpretation:* 
- The median posterior estimate for mu_alpha at 264 (231, 297) suggests that the average baseline SGAJ level across the population (reference conditions) is approximately 265 units, a higher value than the suggested average SGAJ (225) from the previous cohort. The posterior median for sigma_alpha (standard deviation across all individuals) at reference conditions is 91.8 (80.8, 99.6) which is also slightly higher than the value suggested from the previous study.
- The median value for mu_gamma at 10.5 implies an average rate of increase across the population (reference conditions) of about 10.5 units in SGAJ levels every 6 hours. However, the broad 95% credible interval from -4.51 to 23.8 indicates substantial uncertainty, suggesting that in some scenarios, SGAJ levels might even decrease. The median of sd_gamma at 22.2, with a range from 2.152 to 50.1, reflects high variability in the rate of change of SGAJ levels among patients. This suggests that individual responses to treatment vary notably.

## 2.5 Visualising rate of change per day per patient

```{r}
# Get dataframe for rate of change variable - showing 
rate_of_change_df <- get_posterior_summary(sgaj_draws, c("rate_of_change"))[,c("2.5%", "50%", "97.5%")]
colnames(rate_of_change_df) <- c("lower", "median", "upper")
rate_of_change_df$patient <- as.factor(1:12)

unique_sgaj <- sgaj %>%
  select(patient, female, age) %>%
  distinct() %>% mutate(patient = as.factor(unique_sgaj$patient))

rate_of_change_df <- rate_of_change_df %>%
  left_join(unique_sgaj, by = "patient") %>%
  mutate(patient = reorder(patient, median))


# Plotting the data with facets and ages as labels
ggplot(rate_of_change_df, aes(x = patient, y = median, color = as.factor(female))) +
  geom_point(size = 3) +
  geom_text(aes(label = age, vjust = 5, hjust=-0.5), size = 3) +  # Add age labels
  scale_color_manual(values = c("blue", "pink"), labels = c("Male", "Female")) +
  geom_errorbar(aes(ymin = lower, ymax = upper), width = 0.2) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "gray") +
  theme_classic() +
  theme(
    axis.text.x = element_text(size = 10), 
    axis.text.y = element_text(size = 10),  
    axis.ticks = element_line(size = 1)    
  ) +
  labs(
    y = expression(Rate~of~Change~(mu*mol/L)),
    x = "Patient (Ordered by Median Rate of Change)",
    title = "Rate of Change in SGAJ Levels Per Day Across Patients",
    color = "Gender",
    size = "Age"
  )

```
The plot shows the rate of change of SGAJ levels per day for each patient. The following insights can be drawn:

- Most patients show an increase in SGAJ levels as indicated by positive median values. The error bars, representing the 95% confidence interval, suggest varying degrees of uncertainty in the rate of change estimates. Some patients (like patient 3) exhibit large intervals, denoting less precise estimates, whereas others (e.g., patient 2) show narrower intervals, reflecting more certainty in their rates of change.
- Age labels, placed near each point, allow for an examination of patterns related to age. While the plot doesn't show a linear trend, there is a noticeable presence of older patients (ages 77, 78, 83) in the segment with higher rates of change. This could suggest that older patients have a more pronounced response in the first 24 hours.
**Gender Trends:**
- Differentiating patients by gender shows that both males (blue) and females (pink) are present across the spectrum of the rate of change. There isn't a clear gender-based trend; both genders include patients with both high and low rates of change. However, the patient with the highest rate of change is male, which may be worth further investigation to determine if this is an outlier or part of a broader gender-related pattern.

**Interpreting Variability:**
- The inter-patient variability underscores the personalized nature of the biological response to treatment, suggesting that factors such as age, gender, and possibly others not shown on the plot (such as underlying health conditions or genetic factors) play a role in SGAJ level changes.
- Such variability highlights the potential need for personalized approaches to treatment dosing and monitoring to account for these differences.

**Concluding Thoughts:**
- In conclusion, while individual responses vary, there seems to be an age-related pattern where older patients might experience more significant changes in SGAJ levels. The absence of a distinct gender pattern suggests that sex alone may not be a primary determinant of SGAJ rate of change in this sample. The analysis suggests a complex interplay of factors influencing SGAJ level changes and emphasizes the importance of considering both demographic and biological factors in patient care and clinical decision-making.

```{r}
rate_of_change_df$difference <- rate_of_change_df$upper - rate_of_change_df$lower
View(rate_of_change_df)
```

## 2.6 Model limitations
- No interaction terms considered, which simplifies the model considerably. This is the starting model for a full analysis that would have been conducted in a real publication scenario.
- Limited number of samples
- Only data for the first 24 hours, not sure if the model generalises well past the 24 hour mark. The behaviour of SGAJ rate of change might change significantly after the first 24 hours.


# Part 3
```{r}
# Add new row for patient 12 with timepoint = 30 and measured = NA.
sgaj_miss<- rbind(sgaj, c(12, 1, 77, 30, NA))

data_miss <- list(n_patients = length(unique(sgaj_miss$patient)), 
             patient = sgaj_miss$patient,
             age = sgaj_miss$age,
             time = sgaj_miss$time,
             female = sgaj_miss$female,
             n = nrow(sgaj_miss),
             y = sgaj_miss$measured
)
```

```{r}
jags_model_miss <- jags.model(textConnection(model), 
                         data = data_miss, 
                         inits = initial_values, 
                         n.chains = 2)

# Burn-in
update(jags_model_miss, 1000)

pars_miss <- c("mu", "yrep")

# Sampling
samples_miss <- coda.samples(jags_model_miss, 
                        variable.names = pars_miss,
                        n.iter = 200000,
                        thin=10)
samples_miss_draws <- as_draws(samples_miss)

# Get last yrep - which is the one for patient 12 at 30 hours.
y.pred <- extract_variable(samples_miss_draws,  paste0("yrep[",data_miss$n,"]"))

# Find probability (based on posterior predictive distribution) that it is above 500. 
mean(y.pred > 500)
```

```{r}
# get ids of patient 12 - to use to get yrep.
ids_patient_12 <- rownames(sgaj_miss[sgaj_miss$patient == 12, ])

# Get dataframe with observations only for patient 12
sgaj_miss_patient_12 <- sgaj_miss[sgaj_miss$patient == 12, ] %>% 
  mutate(index = 1:6)

# Get summary for mu (fitted mean) and yrep (posterior predictive)
samples_miss_mu_pp <- summary(subset_draws(samples_miss_draws, c(
    paste0("mu[", ids_patient_12, "]"),
    paste0("yrep[", ids_patient_12, "]")
  )), ~ quantile(.x, probs = c(0.025, 0.5, 0.975))) %>% mutate(
    index = rep(1:nrow(sgaj_miss_patient_12), 2),
    Uncertainty = if_else(
      str_detect(variable, "mu"),
      "Fitted mean",
      "Posterior-predictive"
    )
)

# Combine datasets
combined_df_patient_12 <-
  samples_miss_mu_pp %>% left_join(sgaj_miss_patient_12, by = "index")  %>%
  mutate(
    Point = if_else(is.na(measured), "Predicted", "Observed"),
    measured = if_else(is.na(measured), `50%`, measured)
  )

ggplot(combined_df_patient_12, aes(x=time, y=measured)) + geom_ribbon(aes(ymin=`2.5%`,ymax=`97.5%`,fill=Uncertainty), alpha = 0.15) + geom_point(aes(col = Point))+ theme_classic()
```

# Part 4
Conduct a posterior predictive check for the measurement at 18 hours after SEYAB administration for patient id = 3.
#TODO::: getting from the original model (not the one with missing) - think if this is fine
```{r}
# get posterior predictive distribution for patient with id=3. From the original model (not the one with missing)
index_patient_3_time_18 <- rownames(sgaj[sgaj$patient == 3 & sgaj$time==18,])

yrep_patient_3_time_18 <- extract_variable(sgaj_draws, paste0("yrep[",index_patient_3_time_18,"]")) %>% as_tibble()
summary(yrep_patient_3_time_18)

obs_patient_3_time_18 <- as.numeric(sgaj[index_patient_3_time_18,]$measured)
     
# Calculate the p-value
p_value <- mean(yrep_patient_3_time_18$value < obs_patient_3_time_18)

# Create the plot
yrep_patient_3_time_18 %>%
  ggplot(aes(x = value)) +
  geom_density() +  # Plotting the density
  geom_vline(aes(xintercept = obs_patient_3_time_18), color="blue", linetype="dashed", linewidth=1) +  # Observed value line
  annotate("text", x = obs_patient_3_time_18, y = 0, label = paste0("p = ", round(p_value, 3)), color = "blue") +  # Adding the p-value annotation
  labs(x = "Measured SGAJ", y = "Density") +  # Adding labels
  theme_classic()  # Using classic theme
```
Because of the conservatism of p-values the very large p-value that we got, likely indicates that the posterior distribution for patient 3 lacks fit to the data.

either outlier or the model is not good enough. In either case comment that we have very few samples.

# TODO: add comment however very high compared to others! perhaps outlier!
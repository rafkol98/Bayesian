---
title: "Bayesian Coursework"
output: pdf_document
date: "2024-04-08"
editor_options: 
  chunk_output_type: inline
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(dplyr)
library(rjags)
library(bayesplot)
library(posterior)
```

```{r load_df}
# Load dataset.
sgaj <- read.csv("sgaj.csv")
head(sgaj, 7)
```

# Part 1

```{r}
summary(sgaj$age)

# Create age groups
sgaj_with_age_groups <- sgaj %>%
  mutate(age_group = case_when(
    age >= 18 & age <= 30 ~ "18-30",
    age >= 31 & age <= 50 ~ "31-50",
    age >= 51 & age <= 70 ~ "51-70",
    age > 70 ~ "71+"
  ))
```

After reviewing the age distribution in the dataset, I decided to categorise the age variable into four groups: 18-30 (young adults), 31-50 (middle-aged adults), 51-70 (older adults), and 71+ (seniors). This is done solely for visualisation purposes (not used in the model) as it allows for the ordering (and separation in facets) of patients based on their age, making the exploration of how age and gender affect SGAJ easier to interpret.

```{r}
ggplot(sgaj_with_age_groups, aes(x = as.factor(time), y = measured, group = patient, color = as.factor(female))) + 
  geom_point(size=3) +
  geom_line(linewidth=1.3) + 
  facet_wrap(~age_group, ncol=4) +
  theme_classic() +
  labs(
    title = "Trajectory of SGAJ levels by Patient - Faceted by Age Group",
    x = "Time After SEYAB Administration (hours)",
    y = "Measured SGAJ (μmol/L)",
    color = "Sex"
  ) +
  scale_color_manual(
    values = c("blue", "pink"), 
    labels = c("Male", "Female")  # Set labels for Male and Female
  )
```

The plot shows the trajectory of SGAJ level (across the timepoints) for each patient, facetted by the different age groups (to aid visualisation). The following insights can be drawn from the plot:

- There appears to be a positive association between age and SGAJ levels, suggesting that older patients tend to have higher biomarker concentrations.

- In younger age groups, female patients display higher SGAJ levels than male patients (in most time points). In contrast, in the senior age group (71+ years), this pattern is reversed, with male patients presenting higher SGAJ levels.

- Each patient has a different starting level of SGAJ (time=0) which suggests the need for a random intercept. Furthermore, the rate at which SGAJ levels change over time is not constant across patients; In general, older patients have a faster rate SGAJ growth than younger patients but there is still a lot of variability between patients, suggesting the need for a random slope on time.

- Given the limited samples (12 patients), not strong conclusions can be drawn. Furthermore, I acknowledge that unmeasured factors (such as medication, lifestyle) might influence SGAJ levels and could confound the observed associations with age and sex.

# Part 2

## 2.1 Assumptions
- The SGAJ level for patient `i` at time `t` follows a Normal distribution.
- *Linearity:* The model is linear. The relationship between the dependent variable (SGAJ) and each of the independent variables is assumed to be linear.
- *Additive:* Simplifying assumption that there is no interaction between the covariates (model is additive). 
- *Exchangeability:* Before considering the data, we treat all patients as essentially the same.  The prior distributions for the group-specific parameters \( \alpha_i\) and \(\gamma_i\) reflect this assumption. After seeing the data, the model allows these parameters to differ, but the starting point is a belief in their similarity (common prior distribution).

## 2.2 Model formulation
The SGAJ level for each patient `i` at time `t` is assumed to follow a normal distribution with mean $\mu_{it}$ and variance $\psi^2$. The expected SGAJ measurement for patient `i` at time `t` (at reference values) is modeled as $\mu_{it}$. Following the suggestion from the brief, I am fixing the measurement error’s standard deviation ($\psi$) to 75.

$$
\\ y_{it} \sim \mathcal{N}(\mu_{it}, \psi^2)

\\ \mu_{it} = \alpha_i + \beta_{\text{age}}\left(\text{age}_i - 50 \right)/10 + \beta_{\text{female}}(\text{female}_i) + \gamma_{i}\left(\text{time}_t - 12 \right)/6
\\ \psi = 75
$$

### 2.2.1 Priors on alpha
- The variability between patients $i$ is represented by a random effect $\alpha_i$ (patient-specific random intercept), which is assumed to be drawn from a Normal distribution with mean $\mu_a$ and variance $\sigma_a^2$.

$$
\\ \alpha_{i} \sim \mathcal{N}(\mu_{a}, \sigma_a^2)
\\ \mu_a \sim \mathcal{N}(225, 20.41^2)
\\ \sigma_a \sim \text{Uniform}(80, 100)
$$
- I am assuming that the random intercept $a_i$ representing the deviation in baseline SGAJ level for each patient from the population average under reference conditions (age=56, female, time=12 hours), follows a Normal distribution. 

- $\mu_a$ represents the average value (intercept) across the population for the reference group when other predictors (e.g., age, female, time) are held at their reference levels. Being influenced by the information from the previous study, I am assuming that $\mu_a$ has an average value of 225. The standard deviation of $\mu_a$ is calculated as (265-185)/(1.96*2)=20.41, with a 95% upper and lower credible limit of 265 and 185 respectively.

- For the random effects standard deviation $\sigma_a$, I am setting it as a uniform distribution between 80 and 100 to account for some uncertainty around the value 90 suggested from the previous study (because they said it is roughly 90).


### 2.2.2 Priors on beta_age and beta_female
- The terms involving $\beta_{age}$, and $\beta_{female}$ correspond to the fixed effects of age (centered around the age of 50 and scaled such that a unit increase is in 10 years), and female (has the value 1 if female and zero otherwise), respectively. 
$$
\\ \beta_{\text{age}} \sim \mathcal{N}(0, 10^2)
\\ \beta_{\text{female}} \sim \mathcal{N}(-0.1, 10^2)
$$
- For the $\beta_{age}$ and $\beta_{female}$ as the brief explains, the effect is not currently understood well enough and as such I am assuming vague priors, allowing the data to play a primary role in informing these relationships. For the prior of $\beta_{female}$ I am subtly incorporating the expectation that SGAJ levels might be slightly lower in females than in males (as explained by the principal investigator).

### 2.2.3 Priors on gamma
- $\gamma_{i}$ represents the patient-specific rate of change of SGAJ levels per day, accounting for individual variability in response to the drug over time. This is modeled as a random effect to capture the difference in how each patient's SGAJ levels evolve from the baseline measurement at 12 hours after SEYAB administration. Specifically, $\gamma_{i}\left(time_t - 12 \right)/6$ calculates the deviation in SGAJ levels for each patient \(i\) at any given time \(t\), normalized to a 6-hour period (hours per measurement). This reflects the biological variability among patients - without it we would just have different starting points of SGAJ levels among patients (random intercept) but the rate of change over time would be constant across individuals. I am assuming that \(\gamma_{i}\) is drawn from a Normal distribution with mean $\mu_{\gamma}$ and variance $\sigma_{\gamma}^2$.
$$
\\ \gamma_{i} \sim \mathcal{N}(\mu_{\gamma}, \sigma_{\gamma}^2)
\\ \mu_{\gamma} \sim \mathcal{N}(0, 10^2)
\\ \sigma_{\gamma} \sim \text{Uniform}(0, 100)
$$
- For $mu_{gamma}$ and $sigma_{gamma}$ I chose vague priors due to the lack of specific prior information, ensuring that the inferences are driven predominantly by the observed data rather than by subjective assumptions. I chose wide uniform and large variance normal distributions for these priors to offer the flexibility needed for the model to adapt and learn from the data.

## 2.3 RJAGS

# TODO: add pic of drawn model

```{r}
# Initialisation of data
data <- list(n_patients = length(unique(sgaj$patient)), 
             patient = sgaj$patient,
             age = sgaj$age,
             time = sgaj$time,
             female = sgaj$female,
             n = nrow(sgaj),
             y = sgaj$measured
)
```

Constructing a hierarchical linear regression model based on the assumptions and model formulation described above. Checking convergence of the model from two different chains - starting from slightly different initial values.
```{r}
# Model definition
model <- "model{
  # Linear regression model
  for (i in 1:n) {
    mu[i] <- alpha[patient[i]] + beta_age*(age[i] - 50)/10 + beta_female*female[i] + gamma[patient[i]]*(time[i] - 12)/6 
    y[i] ~ dnorm(mu[i], prec_psi)
    yrep[i] ~ dnorm(mu[i], prec_psi) # posterior-predictive distribution
  }
  
  # Random effects
  for (p in 1:n_patients) {
    alpha[p] ~ dnorm(mu_alpha, prec_alpha)
    gamma[p] ~ dnorm(mu_gamma, prec_gamma)
    rate_of_change[p] <- gamma[p] * 4 
  }
  
  # Priors for fixed effects
  beta_age ~ dnorm(0, 1/(10^2))
  beta_female ~ dnorm(-0.1, 1/(10^2))

  # Prior for the population average of the random intercepts
  mu_alpha ~ dnorm(225, 1/(20.41^2))

  # Prior for the standard deviation of the random intercepts
  sd_alpha ~  dunif(80,100)
  prec_alpha <- 1/(sd_alpha^2)
  
  # Prior for the population average of the random slope
  mu_gamma ~ dnorm(0, 1/(10^2))
  
  # Prior for the standard deviation of the random slope
  sd_gamma ~ dunif(0, 100)
  prec_gamma <- 1/(sd_gamma^2)

  prec_psi <- 1/(75^2)
}"


# Two different initial values - to check that the model is converging to the same conclusion
initial_values <- list(list(alpha=rep(200, data$n_patients), sd_alpha=80, mu_gamma=0, sd_gamma=20, beta_age=0, beta_female=0, .RNG.name = c("base::Mersenne-Twister"), .RNG.seed = 20), list(alpha=rep(100, data$n_patients), sd_alpha=95, mu_gamma=1, sd_gamma=50, beta_age=1, beta_female=1, .RNG.name = c("base::Mersenne-Twister"), .RNG.seed = 42))

# Model setup
jags_model <- jags.model(textConnection(model), 
                         data = data, 
                         inits = initial_values, 
                         n.chains = 2)

# Burn-in
update(jags_model, 1000)

pars <- c("alpha", "mu_alpha", "sd_alpha", "beta_age", "beta_female", "gamma", "mu_gamma", "sd_gamma", "rate_of_change", "yrep")

# Sampling
set.seed(2292) 
samples <- coda.samples(jags_model, 
                        variable.names = pars,
                        n.iter = 200000,
                        thin=10)


# Get draws
sgaj_draws <- as_draws(samples)
```

## 2.4 Summarising posterior distributions of key quantities of interest
```{r}
# Function that returns posterior summary for only specified parameters. 
# The summmary includes the 2.5%, 50%, 97.5% quantiles, convergence measures (rhat, ESS), and monte carlo standard error 
get_posterior_summary <- function(draws, pars) {
  subsetted_draws <- subset_draws(draws, variable = pars)
  summary_subsetted_draws <- summary(subsetted_draws, ~quantile(.x, probs = c(0.025, 0.5, 0.975)), default_convergence_measures(), default_mcse_measures())
  
  return(summary_subsetted_draws)
}
```

### 2.4.1 Random intercept
```{r}
mcmc_trace(samples, pars=c(paste0("alpha[",1:12,"]")))
print(get_posterior_summary(sgaj_draws, c(paste0("alpha[",1:12,"]"))))
```
*Convergence:* The traceplots appear to show a “fat hairy caterpillar”, with a stable mean with random dispersion around the mean. Both chains overlap. The rhat statistic is estimated to be 1.00 (within-chain and between-chain variances are similar), giving no suggestion of any lack of convergence. 

#TODO: high mcse

*Interpretation:* 

### 2.4.2 Fixed effects

```{r}
mcmc_trace(samples, pars=c("beta_age", "beta_female"))
print(get_posterior_summary(sgaj_draws, c("beta_age", "beta_female")))
```
*Convergence:* The traceplots show stable mean with random dispersion around the mean and both chains overlap. The rhat statistic is estimated to be 1.00 (within-chain and between-chain variances are similar), giving no suggestion of any lack of convergence. The mean MCSE values for both are smaller than 0.05. 

*Interpretation:* The median value of the \(\beta_{age}\) coefficient at 19.46 indicates that SGAJ levels typically rise by about 19.46 units for each decade past 50 years, and decrease by the same amount per decade before 50. The 95% credible interval from 4.28 to 19.46, however, reveals uncertainty in this age effect, highlighting that while the trend suggests an increase with age, the actual impact could vary, potentially even decreasing SGAJ levels. The \(\beta_{female}\) coefficient's median at 3.13 suggests females have SGAJ levels that are typically 3.13 units higher than males (all other things constant), but with a broad 95% credible interval from -15.96 to 3.13, there is considerable uncertainty around this effect. 

### 2.4.3 Random slope
```{r}
mcmc_trace(samples, pars=c(paste0("gamma[",1:12,"]")))
print(get_posterior_summary(sgaj_draws, c(paste0("gamma[",1:12,"]"))))
```

### 2.4.4 Hyper-parameters 

```{r}
# Check convergence for random intercept (alpha).
mcmc_trace(samples, pars=c("mu_alpha", "sd_alpha", "mu_gamma", "sd_gamma"))
get_posterior_summary(sgaj_draws, c("mu_alpha", "sd_alpha", "mu_gamma", "sd_gamma"))
```

*Convergence:* The traceplots show stable mean with random dispersion around the mean and both chains overlap. All hyperparameters indicate convergence with rhat values at ~1.00. The MCSE for sd_gamma is relatively high at 0.23 indicating that the estimates are not so precise.
# TODO: fix writing

```{r}
get_posterior_summary(sgaj_draws, c("rate_of_change"))
```

*Interpretation*:
- The median posterior estimate for \(\mu_{\alpha}\) at 264.93 suggests that the average baseline SGAJ level across the population is ~265 units under reference conditions, with a 95% credible interval from 232 to 298. The posterior median for \(\sigma_{\alpha}\) is 92.1, with a 95% credible interval from 80.8 to 99.6.
- The median value for \(\mu_{\gamma}\) at 6.27 implies that, on average, there might be a slight increase in the rate of change of SGAJ levels over time, but the wide 95% credible interval from -12.9 to 25.3 suggests considerable uncertainty about this rate, including the possibility of a decrease. The posterior median for \(\sigma_{\gamma}\) at 75.1, with a broad 95% credible interval from 11.2 to 98.9, reflects substantial uncertainty in the patient-specific rates of change of SGAJ levels, with the wide interval indicating that some patients' SGAJ levels could be changing much more rapidly than others, either increasing or decreasing.

## 2.5 Visualising rate of change per day per patient

```{r}
summary_draws_df <- summary_draws %>% as.data.frame()
summary_draws_df <- summary_draws_df[grepl("gamma", summary_draws$variable), c("2.5%", "50%", "97.5%")]
colnames(summary_draws_df) <- c("lower", "median", "upper")
summary_draws_df$patient <- as.factor(1:12)

ggplot(summary_draws_df, aes(x=patient, y=median)) +
  geom_point() +  # Add points for the median values
  geom_errorbar(aes(ymin=lower, ymax=upper), width=.2) +  # Add error bars for the 95% CI
  theme_classic() +
  labs(y = "Rate of Change", x = "Patient", title = "Rate of Change in SGAJ Levels Across Patients") +
  theme(axis.text.x = element_text(hjust = 1))  # Improve x-axis label readability

```
Gammas give the rate of change per patient for every 24 hours after the 12-hour mark.


## 2.6 Model limitations
TODO: enumerate all limitations of the model.

- This is the starting model for a full analysis that would have been conducted in a real publication scenario.


# Part 3
```{r}
# Add new row for patient 12 with timepoint = 30 and measured = NA.
sgaj_miss<- rbind(sgaj, c(12, 1, 77, 30, NA))

data_miss <- list(n_patients = length(unique(sgaj_miss$patient)), 
             patient = sgaj_miss$patient,
             age = sgaj_miss$age,
             time = sgaj_miss$time,
             female = sgaj_miss$female,
             n = nrow(sgaj_miss),
             y = sgaj_miss$measured
)
```

```{r}
jags_model_miss <- jags.model(textConnection(model), 
                         data = data_miss, 
                         inits = initial_values, 
                         n.chains = 2)

# Burn-in
update(jags_model_miss, 1000)

pars_miss <- c("mu", "yrep")

# Sampling
samples_miss <- coda.samples(jags_model_miss, 
                        variable.names = pars_miss,
                        n.iter = 200000,
                        thin=10)
samples_miss_draws <- as_draws(samples_miss)

# Get last yrep - which is the one for patient 12 at 30 hours.
y.pred <- extract_variable(samples_miss_draws,  paste0("yrep[",data_miss$n,"]"))

# Find probability (based on posterior predictive distribution) that it is above 500. 
mean(y.pred >= 500)
```

```{r}
# get ids of patient 12 - to use to get yrep.
ids_patient_12 <- rownames(sgaj_miss[sgaj_miss$patient == 12, ])

# Get dataframe with observations only for patient 12
sgaj_miss_patient_12 <- sgaj_miss[sgaj_miss$patient == 12, ] %>% 
  mutate(index = 1:6)

# Get summary for mu (fitted mean) and yrep (posterior predictive)
samples_miss_mu_pp <- summary(subset_draws(samples_miss_draws, c(
    paste0("mu[", ids_patient_12, "]"),
    paste0("yrep[", ids_patient_12, "]")
  )), ~ quantile(.x, probs = c(0.025, 0.5, 0.975))) %>% mutate(
    index = rep(1:nrow(sgaj_miss_patient_12), 2),
    Uncertainty = if_else(
      str_detect(variable, "mu"),
      "Fitted mean",
      "Posterior-predictive"
    )
)

# Combine datasets
combined_df_patient_12 <-
  samples_miss_mu_pp %>% left_join(sgaj_miss_patient_12, by = "index")  %>%
  mutate(
    Point = if_else(is.na(measured), "Predicted", "Observed"),
    measured = if_else(is.na(measured), `50%`, measured)
  )

ggplot(combined_df_patient_12, aes(x=time, y=measured)) + geom_ribbon(aes(ymin=`2.5%`,ymax=`97.5%`,fill=Uncertainty), alpha = 0.15) + geom_point(aes(col = Point))+ theme_classic()
```




# Part 4
Conduct a posterior predictive check for the measurement at 18 hours after SEYAB administration for patient id = 3.
#TODO::: getting from the original model (not the one with missing) - think if this is fine
```{r}
# get posterior predictive distribution for patient with id=3. From the original model (not the one with missing)
index_patient_3_time_18 <- rownames(sgaj[sgaj$patient == 3 & sgaj$time==18,])

yrep_patient_3_time_18 <- extract_variable(basic_draws, paste0("yrep[",index_patient_3_time_18,"]")) %>% as_tibble()
summary(yrep_patient_3_time_18)

obs_patient_3_time_18 <- as.numeric(sgaj[index_patient_3_time_18,]$measured)
     
# Calculate the p-value
p_value <- mean(yrep_patient_3_time_18$value < obs_patient_3_time_18)

# Create the plot
yrep_patient_3_time_18 %>%
  ggplot(aes(x = value)) +
  geom_density() +  # Plotting the density
  geom_vline(aes(xintercept = obs_patient_3_time_18), color="blue", linetype="dashed", linewidth=1) +  # Observed value line
  annotate("text", x = obs_patient_3_time_18, y = 0, label = paste0("p = ", round(p_value, 3)), color = "blue") +  # Adding the p-value annotation
  labs(x = "Measured SGAJ", y = "Density") +  # Adding labels
  theme_classic()  # Using classic theme
```
Because of the conservatism of p-values the very large p-value that we got, likely indicates that the posterior distribution for patient 3 lacks fit to the data.

# TODO: add comment however very high compared to others! perhaps outlier!
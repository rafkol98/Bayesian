---
title: "Bayesian Coursework"
output: pdf_document
date: "2024-04-08"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(ggplot2)
library(dplyr)
library(rjags)
library(bayesplot)
library(posterior)
```

```{r load_df}
# Load dataset.
sgaj <- read.csv("sgaj.csv")
head(sgaj, 7)
View(sgaj)
```

```{r}
# library("GGally")
ggpairs(sgaj)
```

```{r}
n <- 10000

# Generate samples from a Half-Normal distribution
samples <- rnorm(n, mean = 0, sd = 10^2)
summary(samples)
```

# Part 1

```{r}
summary(sgaj$age)

# Create age groups
sgaj <- sgaj %>%
  mutate(age_group = case_when(
    age >= 18 & age <= 30 ~ "18-30",
    age >= 31 & age <= 50 ~ "31-50",
    age >= 51 & age <= 70 ~ "51-70",
    age > 70 ~ "71+"
  ))
```

After reviewing the age distribution in the dataset, I decided to categorise the age variable into four groups: 18-30 (young adults), 31-50 (middle-aged adults), 51-70 (older adults), and 71+ (seniors). This is done solely for visualisation purposes (not used in the model) as it allows for the ordering (and separation in facets) of patients based on their age, making the exploration of how age and gender affect SGAJ easier to interpret.

```{r}
ggplot(sgaj, aes(x = as.factor(time), y = measured, group = patient, color = as.factor(female))) + 
  geom_point(size=3) +
  geom_line(linewidth=1.3) + 
  facet_wrap(~age_group, ncol=4) +
  theme_classic() +
  labs(
    title = "Trajectory of SGAJ levels by Patient - Faceted by Age Group",
    x = "Time After SEYAB Administration (hours)",
    y = "Measured SGAJ (μmol/L)",
    color = "Sex"
  ) +
  scale_color_manual(
    values = c("blue", "pink"), 
    labels = c("Male", "Female")  # Set labels for Male and Female
  )
```

The plot shows the trajectory of SGAJ level (across the timepoints) for each patient, facetted by the different age groups. Here are some insights from the plot:

- Each patient has a different starting level of SGAJ (time=0). 

- Positive association between patient age and SGAJ levels, suggesting that older individuals tend to have higher biomarker concentrations. 

- It  appears that the rate at which SGAJ levels change over time (hours) is not constant across patients; In general, older patients have a faster rate SGAJ growth than younger patients but there is still a lot of variability between patients. This suggests the need for a random slope on time.

- In younger age groups, female patients display higher SGAJ levels than their male counterparts (in most time points). In contrast, in the senior age group (71+ years), this pattern is reversed, with male patients presenting higher SGAJ levels.

- Given the limited samples, these comments are preliminary (not strong conclusions can be drawn).

# Part 2

The rate of change per day of SGAJ for patients is assumed to follow a normal distribution with mean $\mu_{it}$ and variance $\psi^2$. The expected SGAJ measurement for patient `i` at time `t` is modeled as $\mu_{it}$.
$$
\\ \mu_{it} = \alpha_i + \beta_{age}\left(age_i - 56 \right)/10 + \beta_{female}(female_i) + \gamma_{i}\left(time_t - 12 \right)/24
\\ y_{it} \sim \mathcal{N}(\mu_{it}, \psi^2)
$$
- The variability between patients $i$ is represented by a random effect $a_i$ (patient-specific random intercept), which is assumed to be drawn from a Normal distribution with mean $\mu_a$ and variance $\sigma_a^2$. Following the suggestion from the brief, I am fixing the measurement error’s standard deviation ($\psi$) to 75.

- The model is linear and also makes the simplifying assumption that there is no interaction between the covariates (model is additive). This is the starting model for a full analysis that would have been conducted in a real publication scenario.

- The terms involving $\beta_{age}$, and $\beta_{female}$ correspond to the fixed effects of age (centered around the mean age of 56 years and scaled such that a unit increase is in 10 years), and female (has the value 1 if female and zero otherwise), respectively. 

- $\gamma_{i}$ represents the patient-specific rate of change of SGAJ levels per day, accounting for individual variability in response to the drug over time. This is modeled as a random effect to capture the difference in how each patient's SGAJ levels evolve from the baseline measurement at 12 hours after SEYAB administration. Specifically, $\gamma_{i}\left(time_t - 12 \right)/24$ calculates the deviation in SGAJ levels for each patient \(i\) at any given time \(t\), normalized to a 24-hour period to express the rate of change on a per day basis. This allows us to observe and quantify the individual differences in drug metabolism and response, reflecting the biological variability among patients - without it we would just have different starting points of SGAJ levels among patients (random intercept) but the rate of change over time would be constant across individuals. I am assuming that \(\gamma_{i}\) is drawn from a Normal distribution with mean $\mu_{\gamma}$ and variance $\sigma_{\gamma}^2$.

## Priors:
$$
\\ a_{i} \sim \mathcal{N}(\mu_{a}, \sigma_a^2)
\\ \mu_a \sim \mathcal{N}(250, 20.4^2)
\\ \sigma_a \sim \text{Half-Normal}(0, 90^2)
$$
- I am assuming that the random intercept $a_i$ representing the deviation in baseline SGAJ level for each patient from the population average under reference conditions (age 56, female, time 12 hours), follows a Normal distribution. 

- $\mu_a$ represents the average value (intercept) across the population for the reference group when other predictors (e.g., age, female, time) are held at their reference levels. Being influenced by the information from the previous study, I am assuming that $\mu_a$ has an average value of 250 but it can be as low as 210 and as high as 290. I purposefully made it slightly higher than what the previous study suggested since we are now centering age at 56, instead of 50. The standard deviation of $\mu_a$ is calculated as (290-210)/(1.96*2)=20.4, with a 95% upper and lower credible limit of 290 and 210 respectively.

- For the random effects standard deviation $\sigma_a$, I chose to use a half-normal prior with mean 0 and standard deviation 90 (value influenced by the information from the brief).

$$
\\ \gamma_{i} \sim \mathcal{N}(\mu_{\gamma}, \sigma_{\gamma}^2)
\\ \mu_{\gamma} \sim \mathcal{N}(0, 10^2)
\\ \sigma_{\gamma} \sim \text{Uniform}(0, 100)
$$
#### TODO: might change sigma_{gamma} uniform distribution (consider using half-normal - HalfNormal(0,10^2)).
- For $mu_{gamma}$ and $sigma_{gamma}$ I chose vague priors as the rate of change per individuals is not well understood 
#### #TODO: fix this explanation

$$
\\ \beta_{age} \sim \mathcal{N}(0, 10^2)
\\ \beta_{female} \sim \mathcal{N}(-0.1, 10^2)
$$
- For the $\beta_{age}$ and $\beta_{female}$ as the brief explains, the effect is not currently understood well enough and as such I am assuming vague priors, allowing the data to play a primary role in informing these relationships. However, for the prior for $\beta_{female}$ I am subtly incorporating the expectation that SGAJ levels might be slightly lower in females than in males (as explained by the principal investigator).


## rjags

```{r}
# Initialisation of data
data <- list(n_patients = length(unique(sgaj$patient)), 
             patient = sgaj$patient,
             age = sgaj$age,
             time = sgaj$time,
             female = sgaj$female,
             n = nrow(sgaj),
             y = sgaj$measured
)
```

```{r}
set.seed(2292) # setting seed for reproducibility

model <- "model{
  # Linear regression model
  for (i in 1:n) {
    mu[i] <- alpha[patient[i]] + beta_age*(age[i] - 56)/10 + gamma[patient[i]]*(time[i] - 12)/24 + beta_female*female[i]
    y[i] ~ dnorm(mu[i], prec_psi)
    yrep[i] ~ dnorm(mu[i], prec_psi) # posterior-predictive distribution
  }
  
  # Random effects
  for (p in 1:n_patients) {
    alpha[p] ~ dnorm(mu_alpha, prec_alpha)
    gamma[p] ~ dnorm(mu_gamma, prec_gamma)
  }
  
  # Priors for fixed effects
  beta_age ~ dnorm(0, 1/100)
  beta_time ~ dnorm(0, 1/100)
  beta_female ~ dnorm(-0.1, 1/100)

  # Prior for the population average of the random intercepts
  mu_alpha ~ dnorm(250, 1/(20.41^2))

  # Prior for the standard deviation of the random intercepts
  sd_alpha ~ dnorm(0, 1/(90^2))T(0, )
  prec_alpha <- 1/(sd_alpha^2)
  
  # Prior for the population average of the random slope
  mu_gamma ~ dnorm(0, 1/(10^2))
  
  # Prior for the standard deviation of the random slope
  sd_gamma ~ dunif(0, 100)
  prec_gamma <- 1/(sd_gamma^2)

  prec_psi <- 1/(75^2)
}"

# Function to get different initial values - based on random seed.
init_values_func <- function(seed) {
  set.seed(seed)
  return(
    list(
      alpha = rnorm(data$n_patients, 250, sqrt(20.41^2)),
      sd_alpha = abs(rnorm(1, 0, 90)),
      mu_gamma = rnorm(1, 0, 10^2),
      sd_gamma = runif(1, 0, 10^2),
      beta_age = rnorm(1, 0, 10),
      beta_female = rnorm(1, -0.1, 10)
      )
    )
}

# Get two different initial values - to check that the model is converging to the same conclusion
initial_values <- list(init_values_func(42), init_values_func(20))
print("Two different initial values lists")
print(initial_values)
```

```{r}
# Model setup
jags_model <- jags.model(textConnection(model), 
                         data = data, 
                         inits = initial_values, 
                         n.chains = 2)

# Burn-in
update(jags_model, 1000)

pars <- c("beta_age", "beta_female", "gamma")

# Sampling
samples <- coda.samples(jags_model, 
                        variable.names = pars,
                        n.iter = 10000)
```

```{r}
mcmc_trace(samples)
```
TODO: Comment about convergence from two different chains

```{r}
library(posterior)

basic_draws <- as_draws(samples)

summary_draws <- summary(basic_draws, ~quantile(.x, probs=c(0.025, 0.5, 0.975)), default_convergence_measures(), default_mcse_measures())
summary_draws
```

The median value of the \(\beta_{age}\) coefficient at 13.24 indicates that SGAJ levels typically rise by about 13.24 units for each decade past 56 years, and decrease by the same amount per decade before 56. The 95% credible interval from -5.59 to 30.37, however, reveals uncertainty in this age effect, highlighting that while the trend suggests an increase with age, the actual impact could vary, potentially even decreasing SGAJ levels.

The \(\beta_{female}\) coefficient's median at 1.94 suggests females have SGAJ levels that are typically 1.94 units higher than males (all other things constant), but with a broad 95% credible interval from -17.15 to 21.57, there is considerable uncertainty around this effect. 




```{r}

summary_draws_df <- summary_draws %>% as_data_frame()
summary_draws_df <- summary_draws_df[grepl("gamma", colnames(post_samps)), c("2.5%", "50%", "97.5%")]
colnames(summary_draws_df) <- c("lower", "median", "upper")
summary_draws_df$patient <- as.factor(1:12)

ggplot(summary_draws_df, aes(x=patient, y=median)) +
  geom_point() +  # Add points for the median values
  geom_errorbar(aes(ymin=lower, ymax=upper), width=.2) +  # Add error bars for the 95% CI
  theme_classic() +
  labs(y = "Rate of Change (Median)", x = "Patient", title = "Rate of Change in SGAJ Levels Across Patients") +
  theme(axis.text.x = element_text(hjust = 1))  # Improve x-axis label readability

```
Gammas give the rate of change per patient for every 24 hours after the 12-hour mark.
